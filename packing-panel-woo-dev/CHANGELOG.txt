================================================================================
CHANGELOG - Painel de Empacotamento Woo
Guia de Atualizações e Correções
================================================================================

Este arquivo documenta todas as atualizações, correções e melhorias realizadas
no plugin para facilitar a criação de commits e releases futuras.

================================================================================
VERSÃO 0.3.3 - [Data: 2025-12-12]
================================================================================

RESUMO DA VERSÃO:
- Correção: fallback seguro para imagem placeholder quando wc_placeholder_img_url() não está disponível
- Evita fatal error ao renderizar shortcode [packing_panel] em contextos onde WooCommerce não está carregado (ex.: Elementor editor/admin)

--------------------------------------------------------------------------------
CORREÇÕES REALIZADAS:
--------------------------------------------------------------------------------

1. FALLBACK DE IMAGEM PLACEHOLDER (BUGFIX)
   - Arquivo: inc/core/class-utils.php
   - Problema: Fatal error "Call to undefined function wc_placeholder_img_url()" ao renderizar
              shortcode [packing_panel] em contextos onde helper do WooCommerce não está carregado
              (ex.: editor do Elementor, páginas admin)
   - Solução: Criado helper privado get_placeholder_image_url() que:
     * Verifica se wc_placeholder_img_url() está disponível antes de chamar
     * Se disponível → retorna wc_placeholder_img_url()
     * Se não disponível → retorna placeholder padrão do WordPress (includes_url('images/media/default.png'))
   - Impacto: Elimina fatal error e permite renderização do painel em qualquer contexto
   - Locais corrigidos:
     * PPWOO_Utils::prepare_order_items_payload() (linha ~95)
     * PPWOO_Utils::get_order_items() (linha ~476)

--------------------------------------------------------------------------------
ARQUIVOS MODIFICADOS:
--------------------------------------------------------------------------------

1. inc/core/class-utils.php
   - Adicionado: Método privado get_placeholder_image_url() com fallback seguro
   - Alterado: prepare_order_items_payload() usa helper em vez de wc_placeholder_img_url() direto
   - Alterado: get_order_items() usa helper em vez de wc_placeholder_img_url() direto

2. packing-panel-woo-dev.php
   - Versão atualizada: 0.3.2 → 0.3.3

--------------------------------------------------------------------------------
TESTE DE CORREÇÃO:
--------------------------------------------------------------------------------

1. CENÁRIO 1 (ADMIN/ELEMENTOR):
   - Abrir editor do Elementor em uma página com shortcode [packing_panel]
   - Resultado esperado: Não deve ocorrer fatal error
   - Status: ✅ Validado

2. CENÁRIO 2 (FRONTEND):
   - Abrir página publicada com shortcode [packing_panel]
   - Resultado esperado: Lista renderiza normalmente (com imagem do produto ou placeholder)
   - Status: ✅ Validado

--------------------------------------------------------------------------------
NOTAS TÉCNICAS:
--------------------------------------------------------------------------------

1. FALLBACK SEGURO:
   - Helper verifica function_exists() antes de chamar wc_placeholder_img_url()
   - Fallback usa includes_url() do WordPress (sempre disponível)
   - Mantém compatibilidade total com WooCommerce quando disponível
   - Não quebra visualmente quando WooCommerce não está carregado

2. COMPATIBILIDADE:
   - Mantém comportamento original quando WooCommerce está carregado
   - Permite renderização em contextos não-WooCommerce sem erros
   - Placeholder padrão do WP garante que sempre há uma imagem válida

--------------------------------------------------------------------------------
HISTÓRICO DE COMMITS:
--------------------------------------------------------------------------------

Commit: (a ser preenchido após commit)
Data: 2025-12-12
Mensagem: fix: fallback seguro para placeholder de imagem quando WooCommerce não está carregado (v0.3.3)
Arquivos:
  - packing-panel-woo-dev.php (versão atualizada para 0.3.3)
  - CHANGELOG.txt (atualizado com versão 0.3.3)
  - inc/core/class-utils.php (helper get_placeholder_image_url() + substituição de usos)

================================================================================
VERSÃO 0.3.2 - [Data: 2025-12-12]
================================================================================

RESUMO DA VERSÃO:
- Adicionado botão de teste para webhook externo com preview de resposta
- Implementada navegação de abas via AJAX (sem recarregar página)
- Melhorada UX do refresh cache (sem alterar scroll + ícone de concluído)
- Re-inicialização automática de recursos após troca de abas (color picker, toggle Bearer)

--------------------------------------------------------------------------------
FUNCIONALIDADES ADICIONADAS:
--------------------------------------------------------------------------------

1. TESTE DE WEBHOOK EXTERNO
   - Arquivo: inc/admin/class-admin-connection-tab.php
   - Descrição: Botão e endpoint AJAX para testar webhook externo configurado
   - Funcionalidades:
     * Botão "Testar Webhook Externo" na aba Conexão
     * Endpoint AJAX: wp_ajax_ppwoo_test_external_webhook
     * Exibe status HTTP, tempo de resposta (ms), preview do body e chaves JSON decodificadas
     * Reaproveita lógica do PPWOO_WebhookClient (GET/POST + Bearer Token)
     * Tratamento de erros com mensagens claras

2. NAVEGAÇÃO DE ABAS VIA AJAX
   - Arquivo: inc/admin/class-admin-menu.php, assets/js/admin.js
   - Descrição: Troca de abas Estilo/Conexão sem recarregar página
   - Funcionalidades:
     * Intercepta cliques nas abas e faz requisição AJAX
     * Endpoint AJAX: wp_ajax_ppwoo_load_admin_tab
     * Atualiza conteúdo dinamicamente sem mudar URL
     * Re-inicializa recursos após troca:
       - Color picker (wpColorPicker) na aba Estilo
       - Toggle do Bearer Token na aba Conexão
     * Fallback: recarrega página normalmente em caso de erro
     * Script inline removido da aba Conexão (movido para admin.js)

3. MELHORIAS UX REFRESH CACHE
   - Arquivo: assets/js/admin-refresh-cache.js
   - Descrição: Ajustes na experiência do usuário ao atualizar cache
   - Melhorias:
     * Removido scroll automático após atualização (mantém posição atual)
     * Ícone de concluído (dashicons-yes) verde após sucesso
     * Ícone reverte ao estado normal após 3 segundos
     * Feedback visual mais claro de sucesso

--------------------------------------------------------------------------------
ARQUIVOS MODIFICADOS:
--------------------------------------------------------------------------------

1. inc/admin/class-admin-connection-tab.php
   - Adicionado: Seção "Testar Webhook Externo" com botão e área de resultado
   - Adicionado: Método ajax_test_external_webhook() para endpoint AJAX
   - Removido: Script inline do toggle Bearer (movido para admin.js)
   - Melhorado: Estrutura HTML da seção de teste

2. inc/admin/class-admin-menu.php
   - Adicionado: Método ajax_load_admin_tab() para carregar conteúdo de abas via AJAX
   - Funcionalidade: Captura output da aba via ob_start() e retorna HTML

3. assets/js/admin.js
   - Refatorado: Código reorganizado em funções (initColorPickers, initBearerToggle, initAll)
   - Adicionado: Handler para teste de webhook externo (#ppwoo-test-external-webhook)
   - Adicionado: Handler para troca de abas via AJAX (intercepta cliques em .nav-tab-wrapper)
   - Adicionado: Re-inicialização automática de recursos após troca de aba
   - Melhorado: Uso de event delegation para elementos carregados dinamicamente

4. assets/js/admin-refresh-cache.js
   - Removido: Scroll automático na função ppwooNotice()
   - Adicionado: Ícone de concluído (dashicons-yes) verde após sucesso
   - Adicionado: Reversão automática do ícone após 3 segundos

5. packing-panel-woo-dev.php
   - Versão atualizada: 0.3.1 → 0.3.2
   - Adicionado: Handler AJAX para teste de webhook externo
   - Adicionado: Handler AJAX para carregar abas

--------------------------------------------------------------------------------
NOTAS TÉCNICAS:
--------------------------------------------------------------------------------

1. TESTE DE WEBHOOK EXTERNO:
   - Usa configurações atuais (URL, método GET/POST, Bearer Token se habilitado)
   - Parâmetros padrão: action=get_orders, channel=whatsapp
   - Retorna: status_code, elapsed_ms, body_preview, decoded_keys (chaves do JSON)
   - Logs via PPWOO_Debug em cada etapa

2. NAVEGAÇÃO AJAX:
   - Não altera URL do navegador (melhor UX)
   - Re-inicializa recursos automaticamente após troca
   - Fallback para recarregamento normal em caso de erro
   - Event delegation garante funcionamento com conteúdo carregado dinamicamente

3. REFRESH CACHE:
   - Scroll preservado: usuário permanece na mesma posição
   - Feedback visual: ícone verde temporário indica sucesso
   - Não interfere com outras funcionalidades da página

--------------------------------------------------------------------------------
HISTÓRICO DE COMMITS:
--------------------------------------------------------------------------------

Commit: e204cf1
Data: 2025-12-12
Mensagem: feat: teste webhook externo + abas AJAX + UX refresh cache (v0.3.2)
Arquivos:
  - packing-panel-woo-dev.php (versão atualizada para 0.3.2)
  - CHANGELOG.txt (atualizado com versão 0.3.2)
  - inc/admin/class-admin-connection-tab.php (botão teste webhook externo + endpoint AJAX)
  - inc/admin/class-admin-menu.php (endpoint AJAX para carregar abas)
  - assets/js/admin.js (navegação AJAX + handlers de teste)
  - assets/js/admin-refresh-cache.js (UX melhorada: scroll + ícone concluído)
