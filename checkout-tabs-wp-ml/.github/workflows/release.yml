name: Auto Tag & Release for WordPress Plugin

on:
  push:
    branches:
      - develop

# Necessário para criar tags e releases com o GITHUB_TOKEN.
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Detect plugin version from main file
        id: get_version
        run: |
          PLUGIN_FILE=$(grep -rl "Plugin Name:" --include="*.php" .)
          VERSION=$(grep -i "Version:" "$PLUGIN_FILE" | head -n 1 | awk -F': ' '{print $2}' | tr -d '\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "plugin_file=$PLUGIN_FILE" >> $GITHUB_OUTPUT

      - name: Create tag
        id: tag_creation
        uses: actions/github-script@v6
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
        with:
          script: |
            const version = process.env.VERSION;
            const tag = `v${version}`;

            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tag}`
              });
              core.setOutput("tag_exists", "true");
              return;
            } catch (_) {}

            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tag}`,
              sha: context.sha
            });

      - name: Create GitHub Release
        if: steps.tag_creation.outputs.tag_exists != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: "Release v${{ steps.get_version.outputs.version }}"
          body: |
            Release automática gerada pelo GitHub Actions.
            Arquivo principal: ${{ steps.get_version.outputs.plugin_file }}


